<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Rocketjob by rocketjob</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Rocketjob</h1>
      <h2 class="project-tagline">High volume, priority based, background job processing solution for Ruby.</h2>
      <a href="https://github.com/rocketjob/rocketjob" class="btn">View on GitHub</a>
      <a href="https://github.com/rocketjob/rocketjob/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/rocketjob/rocketjob/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="rocketjob-" class="anchor" href="#rocketjob-" aria-hidden="true"><span class="octicon octicon-link"></span></a>rocketjob<a href="http://travis-ci.org/rocketjob/rocketjob"><img src="https://secure.travis-ci.org/rocketjob/rocketjob.png?branch=master" alt="Build Status"></a> <img src="http://ruby-gem-downloads-badge.herokuapp.com/rocketjob?type=total" alt="">
</h1>

<p>High volume, priority based, background job processing solution for Ruby.</p>

<h2>
<a id="status" class="anchor" href="#status" aria-hidden="true"><span class="octicon octicon-link"></span></a>Status</h2>

<p>Beta - Feedback on the API is welcome. API may change.</p>

<p>Already in use in production internally processing large files with millions
of records, as well as large jobs to walk though large databases.</p>

<h2>
<a id="why" class="anchor" href="#why" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why?</h2>

<p>We have tried for years to make both <code>resque</code> and more recently <code>sidekiq</code>
work for large high performance batch processing.
Even <code>sidekiq-pro</code> was purchased and used in an attempt to process large batches.</p>

<p>Unfortunately, after all the pain and suffering with the existing asynchronous
worker solutions none of them have worked in our production environment without
significant hand-holding and constant support. Mysteriously the odd record/job
was disappearing when processing 100's of millions of jobs with no indication
where those lost jobs went.</p>

<p>In our environment we cannot lose even a single job or record, as all data is
business critical. The existing batch processing solution do not supply any way
to collect the output from batch processing and as a result every job has custom
code to collect it's output. rocketjob has built in support to collect the results
of any batch job.</p>

<p>High availability and high throughput were being limited by how much we could get
through <code>redis</code>. Being a single-threaded process it is constrained to a single
CPU. Putting <code>redis</code> on a large multi-core box does not help since it will not
use more than one CPU at a time.
Additionally, <code>redis</code> is constrained to the amount of physical memory is available
on the server.
<code>redis</code> worked very well when processing was below around 100,000 jobs a day,
when our workload suddenly increased to over 100,000,000 a day it could not keep
up. Its single CPU would often hit 100% CPU utilization when running many <code>sidekiq-pro</code>
servers. We also had to store actual job data in a separate MySQL database since
it would not fit in memory on the <code>redis</code> server.</p>

<p><code>rocketjob</code> was created out of necessity due to constant support. End-users were
constantly contacting the development team to ask on the status of "hung" or
"in-complete" jobs, as part of our DevOps role.</p>

<p>Another significant production support challenge is trying to get <code>resque</code> or <code>sidekiq</code>
to process the batch jobs in a very specific order. Switching from queue-based
to priority-based job processing means that all jobs are processed in the order of
their priority and not what queues are defined on what servers and in what quantity.
This approach has allowed us to significantly increase the CPU and IO utilization
across all worker machines. The traditional queue based approach required constant
tweaking in the production environment to try and balance workload without overwhelming
any one server.</p>

<p>End-users are now able to modify the priority of their various jobs at runtime
so that they can get that business critical job out first, instead of having to
wait for other jobs of the same type/priority to finish first.</p>

<p>Since <code>rocketjob</code> uploads the entire file, or all data for processing it does not
require jobs to store the data in other databases.
Additionally, <code>rocketjob</code> supports encryption and compression of any data uploaded
into Sliced Jobs to ensure PCI compliance and to prevent sensitive from being exposed
either at rest in the data store, or in flight as it is being read or written to the
backend data store.
Often large files received for processing contain sensitive data that must not be exposed
in the backend job store. Having this capability built-in ensures all our jobs
are properly securing sensitive data.</p>

<p>Since moving to <code>rocketjob</code> our production support has diminished and now we can
focus on writing code again. :)</p>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>

<p><code>rocketjob</code> is a global "priority based queue" (<a href="https://en.wikipedia.org/wiki/Priority_queue">https://en.wikipedia.org/wiki/Priority_queue</a>)
All jobs are placed in a single global queue and the job with the highest priority
is processed first. Jobs with the same priority are processed on a first-in
first-out (FIFO) basis.</p>

<p>This differs from the traditional approach of separate queues for jobs which
quickly becomes cumbersome when there are for example over a hundred different
types of jobs.</p>

<p>The global priority based queue ensures that the workers are utilized to their
capacity without requiring constant manual intervention.</p>

<p><code>rocketjob</code> is designed to handle hundreds of millions of concurrent jobs
that are often encountered in high volume batch processing environments.
It is designed from the ground up to support large batch file processing.
For example a single file that contains millions of records to be processed
as quickly as possible without impacting other jobs with a higher priority.</p>

<h2>
<a id="management" class="anchor" href="#management" aria-hidden="true"><span class="octicon octicon-link"></span></a>Management</h2>

<p>The companion project <a href="https://github.com/rocketjob/rocket_job_mission_control">rocketjob mission control</a>
contains the Rails Engine that can be loaded into your Rails project to add
a web interface for viewing and managing <code>rocketjob</code> jobs.</p>

<p><code>rocketjob mission control</code> can also be run stand-alone in a shell Rails application.</p>

<p>By separating <code>rocketjob mission control</code> into a separate gem means it does not
have to be loaded where <code>rocketjob</code> jobs are defined or run.</p>

<h2>
<a id="jobs" class="anchor" href="#jobs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Jobs</h2>

<p>Simple single task jobs:</p>

<p>Example job to run in a separate worker process</p>

<div class="highlight highlight-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">MyJob<span class="pl-e"> &lt; RocketJob::Job</span></span>
  <span class="pl-c"># Method to call asynchronously by the worker</span>
  <span class="pl-k">def</span> <span class="pl-en">perform</span>(<span class="pl-smi">email_address</span>, <span class="pl-smi">message</span>)
    <span class="pl-c"># For example send an email to the supplied address with the supplied message</span>
    send_email(email_address, message)
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>To queue the above job for processing:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">MyJob</span>.perform_later(<span class="pl-s"><span class="pl-pds">'</span>jack@blah.com<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>lets meet<span class="pl-pds">'</span></span>)</pre></div>

<h2>
<a id="directory-monitoring" class="anchor" href="#directory-monitoring" aria-hidden="true"><span class="octicon octicon-link"></span></a>Directory Monitoring</h2>

<p>A common task with many batch processing systems is to look for the appearance of
new files and kick off jobs to process them. <code>DirmonJob</code> is a job designed to do
this task.</p>

<p><code>DirmonJob</code> runs every 5 minutes by default, looking for new files that have appeared
based on configured entries called <code>DirmonEntry</code>. Ultimately these entries will be
configurable via <code>rocketjob_mission_control</code>, the web management interface for <code>rocketjob</code>.</p>

<p>Example, creating a <code>DirmonEntry</code></p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">RocketJob</span>::<span class="pl-c1">DirmonEntry</span>.<span class="pl-k">new</span>(
  <span class="pl-c1">path:</span>         <span class="pl-s"><span class="pl-pds">'</span>path_to_monitor/*<span class="pl-pds">'</span></span>,
  <span class="pl-c1">job:</span>          <span class="pl-s"><span class="pl-pds">'</span>Jobs::TestJob<span class="pl-pds">'</span></span>,
  <span class="pl-c1">arguments:</span>    [ { <span class="pl-c1">input:</span> <span class="pl-s"><span class="pl-pds">'</span>yes<span class="pl-pds">'</span></span> } ],
  <span class="pl-c1">properties:</span>   { <span class="pl-c1">priority:</span> <span class="pl-c1">23</span>, <span class="pl-c1">perform_method:</span> <span class="pl-c1">:event</span> },
  <span class="pl-c1">archive_directory:</span> <span class="pl-s"><span class="pl-pds">'</span>/exports/archive<span class="pl-pds">'</span></span>
)</pre></div>

<p>The attributes of DirmonEntry:</p>

<ul>
<li>path </li>
</ul>

<p>Wildcard path to search for files in.
For details on valid path values, see: <a href="http://ruby-doc.org/core-2.2.2/Dir.html#method-c-glob">http://ruby-doc.org/core-2.2.2/Dir.html#method-c-glob</a></p>

<p>Example:</p>

<pre><code>* input_files/process1/*.csv*
* input_files/process2/**/*
</code></pre>

<ul>
<li>job </li>
</ul>

<p>Name of the job to start</p>

<ul>
<li>arguments </li>
</ul>

<p>Any user supplied arguments for the method invocation
All keys must be UTF-8 strings. The values can be any valid BSON type:</p>

<pre><code>* Integer
* Float
* Time    (UTC)
* String  (UTF-8)
* Array
* Hash
* True
* False
* Symbol
* nil
* Regular Expression
</code></pre>

<p><em>Note</em>: Date is not supported, convert it to a UTC time</p>

<ul>
<li>properties </li>
</ul>

<p>Any job properties to set.</p>

<p>Example, override the default job priority:</p>

<div class="highlight highlight-ruby"><pre>{ <span class="pl-c1">priority:</span> <span class="pl-c1">45</span> }</pre></div>

<ul>
<li>archive_directory</li>
</ul>

<p>Archive directory to move the file to before the job is started. It is important to
move the file before it is processed so that it is not picked up again for processing.
If no archive_directory is supplied the file will be moved to a folder called '_archive'
in the same folder as the file itself.</p>

<p>If the <code>path</code> above is a relative path the relative path structure will be
maintained when the file is moved to the archive path.</p>

<ul>
<li>enabled </li>
</ul>

<p>Allow a monitoring entry to be disabled so that it is ignored by <code>DirmonJob</code>.
This feature is useful for operations to temporarily stop processing files
from a particular source, without having to completely delete the <code>DirmonEntry</code>.
It can also be used to create a <code>DirmonEntry</code> without it becoming immediately
active.</p>

<pre><code>
### Starting the directory monitor

The directory monitor job only needs to be started once per installation by running
the following code:

```ruby
RocketJob::Jobs::DirmonJob.perform_later
</code></pre>

<p>The polling interval to check for new files can be modified when starting the job
for the first time by adding:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">RocketJob</span>::<span class="pl-c1">Jobs</span>::<span class="pl-c1">DirmonJob</span>.perform_later <span class="pl-k">do </span>|<span class="pl-smi">job</span>|
  job.check_seconds <span class="pl-k">=</span> <span class="pl-c1">180</span>
<span class="pl-k">end</span></pre></div>

<p>The default priority for <code>DirmonJob</code> is 40, to increase it's priority:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">RocketJob</span>::<span class="pl-c1">Jobs</span>::<span class="pl-c1">DirmonJob</span>.perform_later <span class="pl-k">do </span>|<span class="pl-smi">job</span>|
  job.check_seconds <span class="pl-k">=</span> <span class="pl-c1">300</span>
  job.priority      <span class="pl-k">=</span> <span class="pl-c1">25</span>
<span class="pl-k">end</span></pre></div>

<p>Once <code>DirmonJob</code> has been started it's priority and check interval can be
changed at any time as follows:</p>

<div class="highlight highlight-ruby"><pre><span class="pl-c1">RocketJob</span>::<span class="pl-c1">Jobs</span>::<span class="pl-c1">DirmonJob</span>.first.set(<span class="pl-c1">check_seconds:</span> <span class="pl-c1">180</span>, <span class="pl-c1">priority:</span> <span class="pl-c1">20</span>)</pre></div>

<p>The <code>DirmonJob</code> will automatically re-schedule a new instance of itself to run in
the future after it completes a each scan/run. If successful the current job instance
will destroy itself.</p>

<p>In this way it avoids having a single Directory Monitor process that constantly
sits there monitoring folders for changes. More importantly it avoids a "single
point of failure" that is typical for earlier directory monitoring solutions.
Every time <code>DirmonJob</code> runs and scans the paths for new files it could be running
on a new worker. If any server/worker is removed or shutdown it will not stop
<code>DirmonJob</code> since it will just run on another worker instance.</p>

<p>There can only be one <code>DirmonJob</code> instance <code>queued</code> or <code>running</code> at a time. Any
attempt to start a second instance will result in an exception.</p>

<p>If an exception occurs while running <code>DirmonJob</code>, a failed job instance will remain
in the job list for problem determination. The failed job cannot be restarted and
should be destroyed if no longer needed.</p>

<h2>
<a id="rails-configuration" class="anchor" href="#rails-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rails Configuration</h2>

<p>MongoMapper will already configure itself in Rails environments. <code>rocketjob</code> can
be configured to use a separate MongoDB instance from the Rails application as follows:</p>

<p>For example, we may want <code>RocketJob::Job</code> to be stored in a Mongo Database that
is replicated across data centers, whereas we may not want to replicate the
<code>RocketJob::SlicedJob</code>** slices due to it's sheer volume.</p>

<div class="highlight highlight-ruby"><pre>config.before_initialize <span class="pl-k">do</span>
  <span class="pl-c"># Share the common mongo configuration file</span>
  config_file <span class="pl-k">=</span> root.join(<span class="pl-s"><span class="pl-pds">'</span>config<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>mongo.yml<span class="pl-pds">'</span></span>)
  <span class="pl-k">if</span> config_file.file?
    config <span class="pl-k">=</span> <span class="pl-c1">YAML</span>.load(<span class="pl-c1">ERB</span>.<span class="pl-k">new</span>(config_file.read).result)
    <span class="pl-k">if</span> config[<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pse">#{</span><span class="pl-s1"><span class="pl-c1">Rails</span>.env</span><span class="pl-pse"><span class="pl-s1">}</span></span>_rocketjob]</span>
<span class="pl-s">      options = (config['options']||{}).symbolize_keys</span>
<span class="pl-s">      options[:logger] = SemanticLogger::DebugAsTraceLogger.new('Mongo:rocketjob')</span>
<span class="pl-s">      RocketJob::Config.mongo_connection = Mongo::MongoClient.from_uri(config['uri'], options)</span>
<span class="pl-s">    end</span>
<span class="pl-s">    # It is also possible to store the jobs themselves in a separate MongoDB database</span>
<span class="pl-s">    if config[<span class="pl-pds">"</span></span><span class="pl-c">#{Rails.env}_rocketjob_work]</span>
      options <span class="pl-k">=</span> (config[<span class="pl-s"><span class="pl-pds">'</span>options<span class="pl-pds">'</span></span>]<span class="pl-k">||</span>{}).symbolize_keys
      options[<span class="pl-c1">:logger</span>] <span class="pl-k">=</span> <span class="pl-c1">SemanticLogger</span>::<span class="pl-c1">DebugAsTraceLogger</span>.<span class="pl-k">new</span>(<span class="pl-s"><span class="pl-pds">'</span>Mongo:rocketjob_work<span class="pl-pds">'</span></span>)
      <span class="pl-c1">RocketJob</span>::<span class="pl-c1">Config</span>.mongo_work_connection <span class="pl-k">=</span> <span class="pl-c1">Mongo</span>::<span class="pl-c1">MongoClient</span>.from_uri(config[<span class="pl-s"><span class="pl-pds">'</span>uri<span class="pl-pds">'</span></span>], options)
    <span class="pl-k">end</span>
  <span class="pl-k">else</span>
    puts <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span>mongo.yml config file not found: <span class="pl-pse">#{</span><span class="pl-s1">config_file</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>For an example config file, <code>config/mongo.yml</code>, see <a href="https://github.com/rocketjob/rocketjob/blob/master/test/config/mongo.yml">mongo.yml</a></p>

<h2>
<a id="standalone-configuration" class="anchor" href="#standalone-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Standalone Configuration</h2>

<p>When running <code>rocketjob</code> in a standalone environment without Rails, the MongoDB
connections will need to be setup as follows:</p>

<div class="highlight highlight-ruby"><pre>options <span class="pl-k">=</span> {
  <span class="pl-c1">pool_size:</span>    <span class="pl-c1">50</span>,
  <span class="pl-c1">pool_timeout:</span> <span class="pl-c1">5</span>,
  <span class="pl-c1">logger:</span>       <span class="pl-c1">SemanticLogger</span>::<span class="pl-c1">DebugAsTraceLogger</span>.<span class="pl-k">new</span>(<span class="pl-s"><span class="pl-pds">'</span>Mongo:Work<span class="pl-pds">'</span></span>),
}

<span class="pl-c"># For example when using a replica-set for high availability</span>
uri <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>mongodb://mongo1.site.com:27017,mongo2.site.com:27017/production_rocketjob<span class="pl-pds">'</span></span>
<span class="pl-c1">RocketJob</span>::<span class="pl-c1">Config</span>.mongo_connection <span class="pl-k">=</span> <span class="pl-c1">Mongo</span>::<span class="pl-c1">MongoClient</span>.from_uri(uri, options)

<span class="pl-c"># Use a separate database, or even server for `RocketJob::SlicedJob` slices</span>
uri <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>mongodb://mongo1.site.com:27017,mongo2.site.com:27017/production_rocketjob_slices<span class="pl-pds">'</span></span>
<span class="pl-c1">RocketJob</span>::<span class="pl-c1">Config</span>.mongo_work_connection <span class="pl-k">=</span> <span class="pl-c1">Mongo</span>::<span class="pl-c1">MongoClient</span>.from_uri(uri, options)</pre></div>

<h2>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Requirements</h2>

<p>MongoDB V2.6 or greater. V3 is recommended</p>

<ul>
<li>V2.6 includes a feature to allow lookups using the <code>$or</code> clause to use an index</li>
</ul>

<h2>
<a id="meta" class="anchor" href="#meta" aria-hidden="true"><span class="octicon octicon-link"></span></a>Meta</h2>

<ul>
<li>Code: <code>git clone git://github.com/rocketjob/rocketjob.git</code>
</li>
<li>Home: <a href="https://github.com/rocketjob/rocketjob">https://github.com/rocketjob/rocketjob</a>
</li>
<li>Bugs: <a href="http://github.com/rocketjob/rocketjob/issues">http://github.com/rocketjob/rocketjob/issues</a>
</li>
<li>Gems: <a href="http://rubygems.org/gems/rocketjob">http://rubygems.org/gems/rocketjob</a>
</li>
</ul>

<p>This project uses <a href="http://semver.org/">Semantic Versioning</a>.</p>

<h2>
<a id="author" class="anchor" href="#author" aria-hidden="true"><span class="octicon octicon-link"></span></a>Author</h2>

<p><a href="https://github.com/reidmorrison">Reid Morrison</a> :: <a href="https://github.com/reidmorrison" class="user-mention">@reidmorrison</a></p>

<h2>
<a id="contributors" class="anchor" href="#contributors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contributors</h2>

<ul>
<li><a href="https://github.com/lambcr">Chris Lamb</a></li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/rocketjob/rocketjob">Rocketjob</a> is maintained by <a href="https://github.com/rocketjob">rocketjob</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-52339082-4");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>

